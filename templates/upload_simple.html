{% extends "layout.html" %}

{% block content %}
<div style="padding: 20px;">
    <h2 style="margin-bottom: 12px;">选择图片进行分析</h2>
    <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept="image/*" style="margin-bottom: 12px;" />
        <div>
            <button class="btn-done" type="submit">上传并分析</button>
        </div>
    </form>
    <div style="margin-top:16px;">
        <a href="{{ url_for('camera') }}" style="text-decoration:none;">返回相机页面</a>
    </div>

    <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

    <div>
        <div class="title-bar">
            <span class="section-title">推荐区（点击生成用法卡片）</span>
            <span class="want-more">点击可查看翻译与用法</span>
        </div>
        <div class="chips-wrapper" id="recoWords">
            <!-- 推荐词汇 -->
            <div class="chip" data-kind="word" data-text="moment">moment</div>
            <div class="chip" data-kind="word" data-text="capture">capture</div>
            <div class="chip" data-kind="word" data-text="memory">memory</div>
        </div>
        <div class="chips-wrapper" id="recoPhrases" style="margin-top:6px;">
            <!-- 推荐短语 -->
            <div class="chip" data-kind="phrase" data-text="in the morning">in the morning</div>
            <div class="chip" data-kind="phrase" data-text="take a photo">take a photo</div>
            <div class="chip" data-kind="phrase" data-text="write it down">write it down</div>
        </div>
        <div class="chips-wrapper" id="recoSentences" style="margin-top:6px;">
            <!-- 推荐例句 -->
            <div class="chip" data-kind="sentence" data-text="I want to record this beautiful scene.">I want to record this beautiful scene.</div>
            <div class="chip" data-kind="sentence" data-text="This picture reminds me of happy times.">This picture reminds me of happy times.</div>
        </div>
    </div>

    <!-- 轻量弹窗 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-card" id="modalCard">
            <div id="modalContent"></div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const modalCard = document.getElementById('modalCard');

    function openWordCard(word) {
        modalContent.innerHTML = `
            <div class="wc-header">
                <div>
                    <div class="wc-title">${word}</div>
                    <div class="wc-phonetic">加载中...</div>
                </div>
            </div>
            <div class="wc-definition"> </div>
            <div class="wc-section-title">例句（按水平） :</div>
            <div class="wc-example-en"></div>
            <div class="wc-example-cn"></div>
            <div class="wc-section-title" style="margin-top: 15px;">场景例句 :</div>
            <div class="wc-example-en wc-example-scene"></div>
            <div class="wc-example-cn wc-example-scene-cn"></div>
        `;
        modal.classList.add('active');
        const url = `/api/word_card?word=${encodeURIComponent(word)}&scene=`;
        fetch(url).then(async res => {
            if (!res.ok) throw new Error((await res.json().catch(()=>({}))).message || '加载失败');
            return res.json();
        }).then(data => {
            const phoneticEl = modalContent.querySelector('.wc-phonetic');
            const defEl = modalContent.querySelector('.wc-definition');
            const lvlEnEl = modalContent.querySelector('.wc-example-en');
            const lvlCnEl = modalContent.querySelector('.wc-example-cn');
            const sceneEnEl = modalContent.querySelector('.wc-example-scene');
            const sceneCnEl = modalContent.querySelector('.wc-example-scene-cn');
            if (phoneticEl) {
                const us = data.phonetic_us ? `美: ${data.phonetic_us}` : '';
                const uk = data.phonetic_uk ? `英: ${data.phonetic_uk}` : '';
                phoneticEl.textContent = [us, uk].filter(Boolean).join('  ') || '';
            }
            if (defEl) {
                const pos = data.pos ? `${data.pos} ` : '';
                defEl.innerHTML = `<b>${pos}${data.definition_cn || ''}</b>`;
            }
            if (lvlEnEl) lvlEnEl.textContent = data.examples_level_en || '';
            if (lvlCnEl) lvlCnEl.textContent = data.examples_level_cn || '';
            if (sceneEnEl) sceneEnEl.textContent = data.examples_scene_en || '';
            if (sceneCnEl) sceneCnEl.textContent = data.examples_scene_cn || '';
        }).catch(err => {
            modalContent.innerHTML = `<div style="color:#999;">${err.message || '加载失败'}</div>`;
        });
    }

    function openPhraseCard(text, kind) {
        modalContent.innerHTML = `
            <div class="wc-header">
                <div>
                    <div class="wc-title">${text}</div>
                    <div class="wc-phonetic">加载中...</div>
                </div>
            </div>
            <div class="wc-definition"> </div>
            <div class="wc-section-title">推荐用法 :</div>
            <div class="wc-example-en"></div>
            <div class="wc-example-cn"></div>
        `;
        modal.classList.add('active');
        const url = `/api/phrase_card?q=${encodeURIComponent(text)}&kind=${encodeURIComponent(kind)}`;
        fetch(url).then(async res => {
            if (!res.ok) throw new Error((await res.json().catch(()=>({}))).message || '加载失败');
            return res.json();
        }).then(data => {
            const pho = modalContent.querySelector('.wc-phonetic');
            const def = modalContent.querySelector('.wc-definition');
            const en = modalContent.querySelector('.wc-example-en');
            const cn = modalContent.querySelector('.wc-example-cn');
            if (pho) pho.textContent = data.translation_cn || '';
            if (def) {
                const tips = Array.isArray(data.usage_tips) ? data.usage_tips : [];
                def.innerHTML = tips.map(t => `<div class="badge-green" style="display:inline-block;margin-right:6px;">${t}</div>`).join(' ');
            }
            if (en) en.textContent = data.examples_en || '';
            if (cn) cn.textContent = data.examples_cn || '';
        }).catch(err => {
            modalContent.innerHTML = `<div style="color:#999;">${err.message || '加载失败'}</div>`;
        });
    }

    document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const kind = chip.getAttribute('data-kind');
            const text = chip.getAttribute('data-text');
            if (kind === 'word') openWordCard(text);
            else openPhraseCard(text, kind);
        });
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
    modalCard.addEventListener('click', (e) => { e.stopPropagation(); });
</script>
{% endblock %}
